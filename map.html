<!DOCTYPE html>
<html>
<head>
    <title>–ö–∞—Ä—Ç–∞ Sentinel</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>

    <style>
        html, body { height: 100%; margin: 0; padding: 0; }
        #map { width: 100%; height: 100%; }
        #controls {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: white;
            padding: 5px 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            z-index: 1000; /* –ß—Ç–æ–±—ã –±—ã–ª–æ –ø–æ–≤–µ—Ä—Ö –∫–∞—Ä—Ç—ã */
            font-family: sans-serif;
        
}
        #downloadLink{
            display: block;
            margin-top: 10px;
            padding: 5px;
            background-color: #007bff;
            color: white;
            text-align: center;
            text-decoration: none;
            border-radius: 3px;
}
        .button-hidden{
            display: none !important;
}
    </style>
</head>
<body>
    <div id="controls">
        <label>
            <input type="radio" name="layer_select" value="true_color" checked> True Color
        </label>
        <label>
            <input type="radio" name="layer_select" value="ndvi"> NDVI
        </label>
        <a href = "#" id = "downloadLink" class = "button_hidden">–°–∫–∞—á–∞—Ç—å —Å–Ω–∏–º–æ–∫</a>
    </div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

    <script>
        // --- –ù–ê–°–¢–†–û–ô–ö–ò ---
const mapCenter = [41.01, 28.97];
const mapZoom = 12;

// --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ö–ê–†–¢–´ ---
const map = L.map('map').setView(mapCenter, mapZoom);

// --- –°–õ–û–ò ---
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
}).addTo(map);

const drawnItems = new L.FeatureGroup();
map.addLayer(drawnItems);

// –°–ª–æ–π –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–ª—É—á–µ–Ω–Ω–æ–≥–æ —Å–Ω–∏–º–∫–∞
let imageOverlay = null;
const downloadLink = document.getElementById('downloadLink');

// --- –ò–ù–°–¢–†–£–ú–ï–ù–¢–´ –†–ò–°–û–í–ê–ù–ò–Ø ---
const drawControl = new L.Control.Draw({
    edit: false, // –û—Ç–∫–ª—é—á–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    draw: {
        polygon: false,
        rectangle: true, // –û—Å—Ç–∞–≤–∏–º —Ç–æ–ª—å–∫–æ –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫
        circle: false,
        marker: false,
        circlemarker: false,
        polyline: false
    }
});
map.addControl(drawControl);

// --- –ì–õ–ê–í–ù–û–ï –°–û–ë–´–¢–ò–ï: –û–¢–ü–†–ê–í–ö–ê –ó–ê–ü–†–û–°–ê –ü–û–°–õ–ï –†–ò–°–û–í–ê–ù–ò–Ø ---
map.on(L.Draw.Event.CREATED, function (e) {
    const layer = e.layer;
    const bounds = layer.getBounds();
    
    // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ñ–∏–≥—É—Ä—ã –∏ —Å–Ω–∏–º–∫–∏
    drawnItems.clearLayers();
    if (imageOverlay) {
        map.removeLayer(imageOverlay);
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞—Ä–∏—Å–æ–≤–∞–Ω–Ω—É—é —Ä–∞–º–∫—É –Ω–∞ –∫–∞—Ä—Ç—É
    drawnItems.addLayer(layer);

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≥—Ä—É–∑–∫–µ
    const popup = L.popup()
        .setLatLng(bounds.getCenter())
        .setContent('üõ∞Ô∏è –ó–∞–ø—Ä–∞—à–∏–≤–∞—é —Å–Ω–∏–º–æ–∫...')
        .openOn(map);

    // 1. –ì–æ—Ç–æ–≤–∏–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
    const bbox = [bounds.getSouthWest().lng, bounds.getSouthWest().lat, bounds.getNorthEast().lng, bounds.getNorthEast().lat];
    const selectedLayer = document.querySelector('input[name="layer_select"]:checked').value;
    const backendUrl = 'http://127.0.0.1:8000/get-image';
    downloadLink.classList.add('button-hidden');

    // 2. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å (fetch) –Ω–∞ –±—ç–∫–µ–Ω–¥
    fetch(backendUrl, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ bbox: bbox ,layer_type:selectedLayer}) // –£–ø–∞–∫–æ–≤—ã–≤–∞–µ–º –Ω–∞—à–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ JSON
    })
    .then(response => {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –æ—Ç–≤–µ—Ç–∏–ª —É—Å–ø–µ—à–Ω–æ (–∫–æ–¥ 200)
        if (!response.ok) {
            throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}`);
        }
        // –°–µ—Ä–≤–µ—Ä –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –ø–æ—ç—Ç–æ–º—É –º—ã —á–∏—Ç–∞–µ–º –µ–≥–æ –∫–∞–∫ "blob"
        return response.blob();
    })
    .then(imageBlob => {
        // 3. –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø–æ–ª—É—á–µ–Ω–Ω—ã–π —Å–Ω–∏–º–æ–∫ –Ω–∞ –∫–∞—Ä—Ç–µ
        const imageUrl = URL.createObjectURL(imageBlob);
        
        imageOverlay = L.imageOverlay(imageUrl, bounds).addTo(map);
        
        // –£–±–∏—Ä–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≥—Ä—É–∑–∫–µ
        map.closePopup(popup);
        //–î–µ–ª–∞–µ–º –∫–Ω–æ–ø–∫—É –≤–∏–¥–∏–º–æ–π –∏ –∞–∫—Ç–∏–≤–Ω–æ–π 
        downloadLink.href = 'http://127.0.0.1:8000/download-image';
        downloadLink.classList.remove('button-hidden')
    })
    .catch(error => {
        // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –≤—ã–≤–æ–¥–∏–º –µ—ë –≤ –ø–æ–ø–∞–ø–µ –∏ –≤ –∫–æ–Ω—Å–æ–ª—å
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–Ω–∏–º–∫–∞:', error);
        popup.setContent(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`);
        downloadLink.classList.add('button-hidden')
    });
});

    </script>

</body>
</html>